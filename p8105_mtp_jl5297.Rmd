---
title: "p8105_mtp_jl5297"
author: "Jun Lu"
date: "10/16/2018"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(patchwork)
library(ggridges)
knitr::opts_chunk$set(
    fig.align = 'center',
    fig.width = 6,
    fig.asp = 0.8,
    out.width = "80%",
    message = F,
    warning = F
 )
theme_set(theme_bw() + theme(legend.position = "bottom"))
options(scipen = 999)
```

## Overview
This document conducts analyses focused on understanding patterns of physical activity of a participant over 47 weeks. The data for this project was collected on a 63 year-old male with BMI 25, who diagnosed with congestive heart failure. He wore an accelerometerdevice that continuously recorded physical activity for several months.

## Data cleaning
```{r}
activity_df = read_csv("./data/p8105_mtp_data.csv") %>% 
    gather(key = minute, value = activity_counts, activity.1:activity.1440) %>%
    mutate(minute = str_replace(minute, "activity.", ""),
           day = fct_relevel(day, c("Sunday", "Monday", "Tuesday","Wednesday", "Thursday",
                                    "Friday", "Saturday")),
           minute = as.integer(minute)) %>% 
    arrange(week, day, minute)

str(activity_df)
```
We load the data from  “p8105_mtp_data.csv” and use `gather` to go from wide to long formats. Activity.1-1440 are transformed into a column named minute.
Two variables(`minute` and `day`) are transformed into integer and factor. There are `r nrow(activity_df)` observations and `r ncol(activity_df)` variables.

* `week`: Week of observation
* `day`: Day of the week
* `minute`: Minute of observation
* `activity_counts`: Voltage signals in one minute epochs that are a proxy for acceleration

## Exploratory analysis
### Density plot of activity counts
```{r}
activity_df %>% 
    ggplot(aes(x = activity_counts)) +
    geom_density() +
    labs(
        title = "Density Plot of Activity Counts",
        x = "Activity Counts/Minute",
        y = "Density"
    )
```

We can see the distribution of `activity_counts` is extremely skewed where some points are much larger than the bulk of the data. The range of activity counts is (`r range(activity_df$activity_counts)`). When the device detects no activity, activity counts equal to 1.

### Find days with no activity 
```{r}
activity_df %>% 
    group_by(week, day) %>% 
    summarize(total_activity = sum(activity_counts)) %>%  
    filter(total_activity == 1440) 
```

We find that there are 18 days that activity counts show no activity(not wear the device). Those days are mainly in week 3, 4 and 12.


## Total activity analysis
### Total activity trend analysis
```{r total_activity_trend, message=FALSE}
activity_df %>% 
    group_by(week) %>% 
    summarise(total_activity = sum(activity_counts)) %>% 
    ggplot(aes(x = week, y = total_activity)) +
    geom_point() +
    geom_line() +
    geom_smooth() +
    labs(
        title = "Week Total Activity Counts vs Week",
        x = "Week",
        y = "Week Total Activity Counts"
    )
```

We aggregate accross minutes of each week to create a total activity variable and then make a scatterplot of total activity over weeks. While there has been large variability, the total activity has an upward trend over weeks. We can infer that this participant became more active over time. 

### The effect of day of the week on total activity
```{r day_effect, fig.width=8, fig.asp = 0.8, fig.align = 'center'}
day_total_acitivity = 
    activity_df %>% 
    group_by(week, day) %>%
    summarize(day_total_activity = sum(activity_counts))

day_total_boxplot =
    day_total_acitivity %>% 
    ggplot(aes(x = day, y = day_total_activity, fill = day)) +
    geom_boxplot() +
    theme(legend.position = "right",
          axis.text.x = element_text(angle = 30, hjust = 1)) +
    labs(
        title = "Day Total Activity for Different Days of the Week",
        x = "Day of the Week",
        y = "Day Total Activity Counts"
    )


day_total_difference =
    day_total_acitivity %>% 
    group_by(week) %>% 
    mutate(difference = day_total_activity - mean(day_total_activity)) %>%
    ggplot(aes(x = day, y = difference, fill = day)) + 
    geom_boxplot() + 
    theme(legend.position = "right",
          axis.text.x = element_text(angle = 30, hjust = 1)) +
    labs(
        title = "Difference Values for Different Days of the Week",
        x = "Day of the Week",
        y = "Difference Values"
    )
    
day_total_boxplot + day_total_difference + plot_layout(ncol = 1)
```

* Aggregate accross minutes of each day to create a day total activity variable. 
* Make boxplots of day total activity of different days of the week.
* In order to remove the effect of the time, we calculate difference values between day total activity and the mean of day total activity of the week. And then we make boxplots of these difference values of of different days of the week.    

As IQR of boxplots overlap and their medians are not significant different(both in two plots), there is no enough evidence that that day of the week affects total activity.

## Distribution of activity counts by hour
```{r}
activity_df %>% 
    mutate(hour = (minute - 1) %/% 60,
           activity_counts = log(activity_counts)) %>%
    ggplot(aes(x = activity_counts, y = factor(hour))) +
    geom_density_ridges(scale = 4) +
    geom_vline(xintercept = 0, color = "red") +
    geom_vline(xintercept = 6, color = "blue") +
    labs(
        title = "Density Plot of Log (Activity Counts) by Hour",
        x = "Log (Activity Counts)",
        y = "Hour of the Day"
    ) 
```

We make a density plot of log(activity counts) by hour. We can see this participant tended to have activity from 7:00 to 22:00.

## 24-hour activity profiles analysis
```{r 24-hour, fig.width=9, fig.asp = 0.9, fig.align = 'center'}
activity_df %>% 
    mutate(period = week %/% 16,
           period = factor(period, levels = c(0, 1, 2), labels = c("1-15 weeks", "16-31 weeks", "32-47 weeks")),
           time = minute %/% 10 * 10 / 60) %>% 
    group_by(period, week, day, time) %>% 
    summarize(activity_counts = sum(activity_counts)) %>% 
    ggplot(aes(x = time, y = activity_counts, color = period)) +
    geom_line(aes(group = week), size = 0.05, alpha = 0.7) +
    facet_grid(. ~ day) +
    geom_smooth(size = 1, aes(group = period, color = period)) +
    scale_x_continuous(breaks = seq(0, 24, by = 6)) +
    ylim(0, 40000) +
    labs(
        title = "24-Hour Activity Profiles for Each Day",
        x = "Hour of the Day",
        y = "Activity Counts/ 20 Minutes"
    ) 
```

We divide weeks into 3 periods and aggregate data into 20-minute epochs. Then we make a plot which shows 24-hour activity profiles for each day in panels defined by day of the week. Smooth estimates of each period are emphasized as bold curves.

* This participant became more active over periods, especially on Thursday, Friday, Saturday and Sunday when this participant was likely to have higher activity than other days. 
* This participant tended to have high activity around 9:00 and 17:00 on Sunday.
* This participant tended to have high activity around 20:00 on Friday.



